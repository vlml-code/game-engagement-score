<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Engagement Score</title>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css" />
    <style>
      body {
        padding: 2rem;
        background: radial-gradient(circle at 10% 20%, #f4f7ff, #ffffff 35%);
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
      }
      .pill {
        border-radius: 999px;
        padding: 0.2rem 0.75rem;
        background: var(--muted-border-color);
        font-size: 0.9rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }
      .secondary-text {
        color: var(--muted-color);
      }
      .badge-main {
        background: #e8f4ff;
        color: #0a4a8a;
        border-radius: 999px;
        padding: 0.15rem 0.6rem;
        font-size: 0.8rem;
        border: 1px solid #b9dcff;
      }
      .section {
        margin-top: 1rem;
        padding-top: 0.5rem;
        border-top: 1px solid var(--muted-border-color);
      }
      .score {
        font-weight: 700;
        font-size: 1.2rem;
      }
      .muted-bg {
        background: #f7f7fb;
        padding: 0.75rem;
        border-radius: 0.75rem;
      }
      .notes {
        font-size: 0.95rem;
        color: var(--muted-color);
      }
      .content-preview {
        font-size: 0.95rem;
        white-space: pre-wrap;
      }
      .control-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .log-panel {
        background: #0d1117;
        color: #e6edf3;
        padding: 1rem;
        border-radius: 0.75rem;
        font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        max-height: 320px;
        overflow: auto;
        border: 1px solid #161b22;
      }
      .log-entry {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
        padding: 0.35rem 0;
        border-bottom: 1px solid #1f2933;
      }
      .log-entry:last-child {
        border-bottom: none;
      }
      .log-entry small {
        color: #8b949e;
        min-width: 84px;
      }
      .log-entry .label {
        padding: 0.05rem 0.5rem;
        border-radius: 0.4rem;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      .log-entry .label.info {
        background: rgba(99, 139, 255, 0.16);
        color: #9db7ff;
      }
      .log-entry .label.success {
        background: rgba(45, 212, 191, 0.16);
        color: #5ad1c3;
      }
      .log-entry .label.error {
        background: rgba(248, 113, 113, 0.16);
        color: #fba9a9;
      }
      .inline-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .small-label {
        font-size: 0.85rem;
        color: var(--muted-color);
      }
      .stacked {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
      }
      .summary-card {
        background: white;
        border: 1px solid var(--muted-border-color);
        border-radius: 0.9rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
      }
      .summary-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .summary-table th,
      .summary-table td {
        padding: 0.75rem;
        text-align: left;
      }
      .summary-table thead {
        background: #f5f7fb;
        border-bottom: 1px solid var(--muted-border-color);
      }
      .summary-table tbody tr + tr {
        border-top: 1px solid var(--muted-border-color);
      }
      .summary-table .muted {
        color: var(--muted-color);
      }
    </style>
  </head>
  <body>
    <main class="container">
      <header>
        <h1>Game Engagement Score</h1>
        <p class="secondary-text">
          Import Steam apps, parse community guides, detect the main-story achievement with OpenAI,
          fetch HowLongToBeat times, and compute engagement automatically.
        </p>
        <div class="inline-actions">
          <a role="button" href="/docs" target="_blank">Open API docs</a>
          <span class="pill">Use the panels below to call the API without leaving this page.</span>
        </div>
      </header>

      <section class="summary-card">
        <div style="display:flex; justify-content: space-between; align-items:center; gap:1rem; flex-wrap: wrap">
          <div>
            <h2 style="margin:0">Game analytics at a glance</h2>
            <p class="secondary-text" style="margin:0">Main-story detections, completion rates, playtime, and engagement score.</p>
          </div>
          <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap: wrap">
            <button id="analyze-all" type="button">Analyze games without scores</button>
            <button id="refresh-games" type="button" class="secondary">Refresh games</button>
          </div>
        </div>
        <div class="muted-bg" style="margin-top: 1rem; overflow-x: auto;">
          <table class="summary-table">
            <thead>
              <tr>
                <th>Game</th>
                <th>Main-story achievement</th>
                <th>% completed</th>
                <th>Main story hours</th>
                <th>Engagement score</th>
              </tr>
            </thead>
            <tbody id="summary-rows">
              <tr>
                <td colspan="5" class="muted">Loading games...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <section>
        <h2>Operations console</h2>
        <p class="secondary-text">
          Drive every API endpoint from the UI: seed games, import from Steam, and run the full
          analysis pipeline with detailed logging of each step.
        </p>
        <div class="grid control-grid">
          <article>
            <header class="stacked">
              <strong>Create a game</strong>
              <span class="small-label">POST /api/games</span>
            </header>
            <form id="game-form">
              <label>Title<input id="game-title" type="text" name="title" required /></label>
              <label>Steam App ID<input id="game-steam" type="number" name="steam_app_id" /></label>
              <label>Genre<input id="game-genre" type="text" name="genre" /></label>
              <label>Platform<input id="game-platform" type="text" name="platform" /></label>
              <label>Description<textarea id="game-description" name="description" rows="2"></textarea></label>
              <button type="submit">Save game</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Import from Steam</strong>
              <span class="small-label">POST /api/steam/import</span>
            </header>
            <form id="steam-form">
              <label
                >App IDs (comma or newline separated)
                <textarea id="steam-app-ids" name="app_ids_text" rows="4" required></textarea>
              </label>
              <button type="submit">Import achievements &amp; guides</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Analyze a game</strong>
              <span class="small-label">POST /api/games/&lt;id&gt;/analyze</span>
            </header>
            <form id="analyze-form">
              <label>Game<select id="analyze-game" required></select></label>
              <button type="submit">Run pipeline</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Add achievement</strong>
              <span class="small-label">POST /api/achievements</span>
            </header>
            <form id="achievement-form">
              <label>Game<select id="achievement-game" required></select></label>
              <label>Name<input id="achievement-name" type="text" required /></label>
              <label>Description<textarea id="achievement-description" rows="2"></textarea></label>
              <label>Completion rate (%)<input id="achievement-completion" type="number" min="0" max="100" step="0.01" /></label>
              <button type="submit">Add achievement</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Add guide</strong>
              <span class="small-label">POST /api/guides</span>
            </header>
            <form id="guide-form">
              <label>Game<select id="guide-game" required></select></label>
              <label>Title<input id="guide-title" type="text" required /></label>
              <label>URL<input id="guide-url" type="url" /></label>
              <label>Author<input id="guide-author" type="text" /></label>
              <button type="submit">Save guide</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Parse guide content</strong>
              <span class="small-label">POST /api/parsed-content</span>
            </header>
            <form id="parsed-form">
              <label>Guide<select id="parsed-guide" required></select></label>
              <label>Content<textarea id="parsed-content" rows="3" required></textarea></label>
              <label>Section count<input id="parsed-sections" type="number" min="0" /></label>
              <button type="submit">Attach parsed content</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Log HLTB time</strong>
              <span class="small-label">POST /api/hltb-times</span>
            </header>
            <form id="hltb-form">
              <label>Game<select id="hltb-game" required></select></label>
              <label>Main story hours<input id="hltb-main-story" type="number" min="0" step="0.1" /></label>
              <label>Extras hours<input id="hltb-extras" type="number" min="0" step="0.1" /></label>
              <label>Completionist hours<input id="hltb-completion" type="number" min="0" step="0.1" /></label>
              <button type="submit">Record time</button>
            </form>
          </article>

          <article>
            <header class="stacked">
              <strong>Add engagement score</strong>
              <span class="small-label">POST /api/engagement-scores</span>
            </header>
            <form id="score-form">
              <label>Game<select id="score-game" required></select></label>
              <label>Score<input id="score-value" type="number" min="0" step="0.1" required /></label>
              <label>Method<input id="score-method" type="text" placeholder="hltb_main_story + completion_rate" /></label>
              <label>Notes<textarea id="score-notes" rows="2"></textarea></label>
              <button type="submit">Store score</button>
            </form>
          </article>
        </div>
      </section>

      <section>
        <h2>Activity log</h2>
        <p class="secondary-text">Each submission below captures the outbound request and server response.</p>
        <div class="log-panel" id="log-panel" aria-live="polite"></div>
      </section>

      <section>
        <h2>Games</h2>
        <p class="secondary-text">The cards below reflect the latest data returned from the API.</p>
        <div id="games-grid" class="grid"></div>
        <p id="empty-state" class="secondary-text" style="display:none">No games stored yet. Use the console above to add one.</p>
      </section>
    </main>

    <script>
      const logPanel = document.getElementById("log-panel");
      const gamesGrid = document.getElementById("games-grid");
      const emptyState = document.getElementById("empty-state");
      const refreshButton = document.getElementById("refresh-games");
      const analyzeAllButton = document.getElementById("analyze-all");
      const summaryRows = document.getElementById("summary-rows");

      const selects = {
        analyze: document.getElementById("analyze-game"),
        achievement: document.getElementById("achievement-game"),
        guide: document.getElementById("guide-game"),
        parsed: document.getElementById("parsed-guide"),
        hltb: document.getElementById("hltb-game"),
        score: document.getElementById("score-game"),
      };

      function log(message, type = "info") {
        const entry = document.createElement("div");
        entry.className = "log-entry";
        const time = new Date().toLocaleTimeString();
        const label = document.createElement("span");
        label.className = `label ${type}`;
        label.textContent = type;
        const timestamp = document.createElement("small");
        timestamp.textContent = time;
        const body = document.createElement("div");
        body.textContent = message;
        entry.append(timestamp, label, body);
        logPanel.append(entry);
        logPanel.scrollTop = logPanel.scrollHeight;
      }

      function setFormDisabled(form, disabled) {
        Array.from(form.elements).forEach((el) => {
          el.disabled = disabled;
        });
      }

      async function postJSON(url, payload, label) {
        log(`Sending ${label || url}...`);
        const response = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        let data = null;
        try {
          data = await response.json();
        } catch (err) {
          // ignore JSON parse errors for empty responses
        }
        if (!response.ok) {
          const detail = data?.detail || response.statusText;
          throw new Error(Array.isArray(detail) ? detail.join("; ") : detail);
        }
        log(`${label || url} succeeded`, "success");
        return data;
      }

      function option(text, value) {
        const opt = document.createElement("option");
        opt.text = text;
        opt.value = value;
        return opt;
      }

      function escapeHtml(str = "") {
        return str
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      function renderParsedSections(sections = []) {
        if (!sections.length) return "";
        return sections
          .map(
            (section) =>
              `<p>${escapeHtml(section.content).replace(/\n/g, "<br>")}</p>`
          )
          .join("<hr />");
      }

      function updateSelects(games) {
        const gameOptions = games.map((g) => ({ value: g.id, text: `${g.title} (#${g.id})` }));
        Object.values(selects)
          .filter((el) => el !== selects.parsed)
          .forEach((sel) => {
            sel.innerHTML = "";
            sel.append(option("Select a game", ""));
            gameOptions.forEach((g) => sel.append(option(g.text, g.value)));
          });

        const guides = games.flatMap((g) => g.guides.map((guide) => ({
          value: guide.id,
          text: `${guide.title} (Game #${g.id})`,
        })));
        const parsedSelect = selects.parsed;
        parsedSelect.innerHTML = "";
        parsedSelect.append(option("Select a guide", ""));
        guides.forEach((g) => parsedSelect.append(option(g.text, g.value)));
      }

      function renderSummaryTable(games) {
        summaryRows.innerHTML = "";
        if (!games.length) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 5;
          cell.textContent = "No games stored yet.";
          cell.className = "muted";
          row.append(cell);
          summaryRows.append(row);
          return;
        }

        games.forEach((game) => {
          const row = document.createElement("tr");
          const mainStory = game.achievements.find((a) => a.is_main_story_completion);
          const latestHltb = game.hltb_times.at(-1);
          const latestScore = game.engagement_scores.at(-1);

          const cells = [
            game.title,
            mainStory?.name || "Not detected",
            mainStory?.completion_rate != null
              ? `${mainStory.completion_rate.toFixed(2)}%`
              : "‚Äî",
            latestHltb?.main_story_hours != null
              ? `${latestHltb.main_story_hours.toFixed(2)} h`
              : "‚Äî",
            latestScore?.score != null ? latestScore.score.toFixed(1) : "‚Äî",
          ];

          cells.forEach((value) => {
            const cell = document.createElement("td");
            cell.textContent = value;
            if (value === "‚Äî" || value === "Not detected") {
              cell.className = "muted";
            }
            row.append(cell);
          });

          summaryRows.append(row);
        });
      }

      function renderGames(games) {
        gamesGrid.innerHTML = "";
        if (!games.length) {
          emptyState.style.display = "block";
          return;
        }
        emptyState.style.display = "none";
        games.forEach((game) => {
          const mainStory = game.achievements.find((a) => a.is_main_story_completion);
          const latestHltb = game.hltb_times.at(-1);
          const latestScore = game.engagement_scores.at(-1);
          const parsedCount = game.guides.filter((g) => g.parsed_content && g.parsed_content.length).length;

          const article = document.createElement("article");
          article.innerHTML = `
            <header>
              <div style="display: flex; justify-content: space-between; gap: 1rem">
                <div>
                  <h3>${game.title}</h3>
                  <p class="secondary-text">${game.genre || "Unknown genre"} ¬∑ ${game.platform || "Unknown platform"}</p>
                </div>
                <div style="text-align: right">
                  <span class="pill" title="Steam App ID">üéÆ ${game.steam_app_id ?? "N/A"}</span>
                  <div class="small-label">Game ID: ${game.id}</div>
                </div>
              </div>
              <p>${game.description || "No description available."}</p>
            </header>

            <div class="section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h4>Achievements</h4>
                <span class="pill">${game.achievements.length} total</span>
              </div>
              ${game.achievements.length === 0
                ? "<p class=\"secondary-text\">No achievements imported yet.</p>"
                : `<ul>${game.achievements
                    .map((ach) => `
                      <li>
                        <strong>${ach.name}</strong>
                        ${ach.is_main_story_completion ? '<span class="badge-main">Main story</span>' : ""}
                        <br />
                        <span class="secondary-text">${ach.description || "No description provided."}</span>
                        <div class="notes">
                          ${ach.completion_rate !== null && ach.completion_rate !== undefined
                            ? `Completion: ${ach.completion_rate.toFixed(2)}%`
                            : "Completion data missing"}
                        </div>
                      </li>
                    `)
                    .join("")}</ul>`}
            </div>

            <div class="section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h4>Guides & parsed content</h4>
                <span class="pill">${game.guides.length} guides</span>
              </div>
              ${game.guides.length === 0
                ? "<p class=\"secondary-text\">No guides discovered.</p>"
                : `<ul>${game.guides
                    .map((guide) => `
                      <li>
                        <strong>${guide.title}</strong>
                        ${guide.parsed_content?.length ? '<span class="badge-main" style="background:#eefbf0;color:#1c6b2a;border-color:#c1e7c5">Parsed</span>' : ""}
                        <div class="notes">${guide.url || "No URL"}</div>
                        ${guide.parsed_content?.length
                          ? `<div class="content-preview muted-bg">${renderParsedSections(guide.parsed_content)}</div>`
                          : '<div class="secondary-text">Awaiting parsing.</div>'}
                      </li>
                    `)
                    .join("")}</ul>`}
            </div>

            <div class="section">
              <h4>HowLongToBeat</h4>
              ${latestHltb && latestHltb.main_story_hours
                ? `<p class="score">‚è±Ô∏è Main story: ${latestHltb.main_story_hours.toFixed(2)} hours</p>`
                : '<p class="secondary-text">No main-story time recorded yet.</p>'}
            </div>

            <div class="section">
              <h4>Engagement score</h4>
              ${latestScore
                ? `<p class="score">‚≠ê ${latestScore.score.toFixed(1)}</p>${latestScore.notes ? `<p class="notes">${latestScore.notes}</p>` : ""}`
                : '<p class="secondary-text">Run the analysis endpoint to compute a score.</p>'}
            </div>

            <footer style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top: 1rem">
              <span class="pill">Guides parsed: ${parsedCount}</span>
              <span class="pill">HLTB entries: ${game.hltb_times.length}</span>
              <span class="pill">Scores: ${game.engagement_scores.length}</span>
              ${mainStory ? `<span class="pill">Main story: ${mainStory.name}</span>` : ""}
            </footer>
          `;
          gamesGrid.append(article);
        });
      }

      async function refreshGames() {
        log("Fetching games from API...");
        const response = await fetch("/api/games");
        if (!response.ok) {
          log("Failed to fetch games", "error");
          return;
        }
        const games = await response.json();
        updateSelects(games);
        renderSummaryTable(games);
        renderGames(games);
        log(`Loaded ${games.length} game(s)`, "success");
      }

      function handleForm(formId, buildPayload, urlBuilder, label, onSuccess) {
        const form = document.getElementById(formId);
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          setFormDisabled(form, true);
          try {
            const payload = buildPayload();
            const url = typeof urlBuilder === "function" ? urlBuilder(payload) : urlBuilder;
            const data = await postJSON(url, payload, label);
            if (onSuccess) {
              onSuccess(data, payload);
            }
            if (data?.notes) {
              data.notes.forEach((note) => log(note));
            }
            await refreshGames();
            log(JSON.stringify(data, null, 2), "info");
          } catch (err) {
            log(err.message, "error");
          } finally {
            setFormDisabled(form, false);
          }
        });
      }

      handleForm(
        "game-form",
        () => ({
          title: document.getElementById("game-title").value,
          steam_app_id: document.getElementById("game-steam").value || null,
          genre: document.getElementById("game-genre").value || null,
          platform: document.getElementById("game-platform").value || null,
          description: document.getElementById("game-description").value || null,
        }),
        "/api/games",
        "Create game"
      );

      handleForm(
        "steam-form",
        () => ({ app_ids_text: document.getElementById("steam-app-ids").value }),
        "/api/steam/import",
        "Steam import",
        (data) => {
          data?.results?.forEach((result) => {
            const status = result.status === "error" ? "error" : "success";
            const summary = [
              `App ${result.app_id}`,
              result.game_id ? `‚Üí Game #${result.game_id}` : null,
              result.created_game ? "created" : null,
              result.achievements_added ? `${result.achievements_added} achievements` : null,
              result.guides_added ? `${result.guides_added} guides` : null,
              result.guides_parsed ? `${result.guides_parsed} parsed` : null,
            ]
              .filter(Boolean)
              .join(" | ");
            log(summary || `App ${result.app_id}`, status === "success" ? "success" : "error");
            if (result.error) {
              log(result.error, "error");
            }
          });
        }
      );

      handleForm(
        "analyze-form",
        () => ({ game_id: document.getElementById("analyze-game").value }),
        (payload) => `/api/games/${payload.game_id}/analyze`,
        "Analyze game",
        (data, payload) => {
          log(
            `Analysis for game #${payload.game_id}: ` +
              `main story = ${data.main_story_achievement ?? "n/a"}, ` +
              `HLTB = ${data.hltb_main_story_hours ?? "n/a"} hours, ` +
              `engagement = ${data.engagement_score ?? "n/a"}`,
            "success"
          );
        }
      );

      handleForm(
        "achievement-form",
        () => ({
          game_id: Number(document.getElementById("achievement-game").value),
          name: document.getElementById("achievement-name").value,
          description: document.getElementById("achievement-description").value || null,
          completion_rate: document.getElementById("achievement-completion").value || null,
        }),
        "/api/achievements",
        "Create achievement"
      );

      handleForm(
        "guide-form",
        () => ({
          game_id: Number(document.getElementById("guide-game").value),
          title: document.getElementById("guide-title").value,
          url: document.getElementById("guide-url").value || null,
          author: document.getElementById("guide-author").value || null,
        }),
        "/api/guides",
        "Create guide"
      );

      handleForm(
        "parsed-form",
        () => ({
          guide_id: Number(document.getElementById("parsed-guide").value),
          content: document.getElementById("parsed-content").value,
          section_count: document.getElementById("parsed-sections").value || null,
        }),
        "/api/parsed-content",
        "Attach parsed content"
      );

      handleForm(
        "hltb-form",
        () => ({
          game_id: Number(document.getElementById("hltb-game").value),
          main_story_hours: document.getElementById("hltb-main-story").value || null,
          extras_hours: document.getElementById("hltb-extras").value || null,
          completionist_hours: document.getElementById("hltb-completion").value || null,
        }),
        "/api/hltb-times",
        "Create HLTB time"
      );

      handleForm(
        "score-form",
        () => ({
          game_id: Number(document.getElementById("score-game").value),
          score: Number(document.getElementById("score-value").value),
          method: document.getElementById("score-method").value || null,
          notes: document.getElementById("score-notes").value || null,
        }),
        "/api/engagement-scores",
        "Create engagement score"
      );

      analyzeAllButton.addEventListener("click", async () => {
        analyzeAllButton.disabled = true;
        try {
          const results = await postJSON(
            "/api/games/analyze-missing",
            {},
            "Analyze games without scores"
          );
          if (!results?.length) {
            log("No games without engagement scores were found.");
          }
          results?.forEach((result) => {
            log(
              `Analysis for game #${result.game_id}: main story = ${
                result.main_story_achievement ?? "n/a"
              }, HLTB = ${
                result.hltb_main_story_hours ?? "n/a"
              } hours, engagement = ${result.engagement_score ?? "n/a"}`,
              "success"
            );
            result.notes?.forEach((note) => log(note));
          });
          await refreshGames();
        } catch (err) {
          log(err.message, "error");
        } finally {
          analyzeAllButton.disabled = false;
        }
      });

      refreshButton.addEventListener("click", refreshGames);
      refreshGames();
    </script>
  </body>
</html>
